---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo=FALSE, message=FALSE}
has_ggraph <- FALSE
has_caracas <- FALSE

if (require(ggraph, quietly = TRUE) && require(tidygraph, quietly = TRUE)) {
  has_ggraph <- TRUE
}

if (require(caracas, quietly = TRUE)) {
  has_caracas <- TRUE
}

inline_caracas_code <- function(x) {
  x
}

inline_caracas_code <- function(x) {
  deparse(substitute(x))
}

if (has_caracas) {
  inline_caracas_code <- function(x) {
    x
  }
}
```


```{r setup}
library(taldi)
```

# Infering abstract syntex tree

```{r}
e <- quote(cos(2*x1 + x2))
symlist <- infer_ast(e)
str(symlist, 2)
```

# Construct directed acyclic graph

```{r, fig.width=6, fig.height=4}
g <- make_dag(symlist)
plot(g)
```

## Find leaves

```{r}
is_leaf <- sapply(V(g), function(x) {
  length(neighbors(g, x)) == 0L
})
V(g)[is_leaf]
leaves_labels <- get.vertex.attribute(g, "label",  V(g)[is_leaf])
leaves_types <- get.vertex.attribute(g, "type",  V(g)[is_leaf])
cbind(leaves_labels, leaves_types)
```

# Plot using `ggraph` and `tidygraph`

```{r, fig.width=6, fig.height=4, eval = has_ggraph}
tg <- as_tbl_graph(g)
l <- create_layout(tg, layout = "sugiyama")

ggraph(l) + 
  geom_edge_link(arrow = arrow(length = unit(0.5, 'cm')), end_cap = circle(0.5, 'cm')) + 
  geom_node_circle(aes(r = 0.1, fill = type)) + 
  geom_node_text(aes(label = label)) + 
  labs(fill = NULL) + 
  theme_bw() + 
  theme_graph()
```

# Find derivative

```{r, eval = has_caracas}
f <- as_sym(deparse1(e))
f
dfdx1 <- der(f, "x1")
dfdx2 <- der(f, "x2")
```

\begin{align}
  f(x_1, x_2) &= `r inline_caracas_code(tex(f))` \\
  \frac{\partial f}{\partial x_1} &= `r inline_caracas_code(tex(dfdx1))` \\
  \frac{\partial f}{\partial x_2} &= `r inline_caracas_code(tex(dfdx2))`
\end{align}

```{r, eval = has_caracas}
val <- eval_to_symbol("UnevaluatedExpr(pi/2)")

f_val_uneval <- subs_lst(f, list("x1" = val, "x2" = val))
f_val_uneval
f_val <- doit(f_val_uneval)
f_val

dfdx1_val_uneval <- subs_lst(dfdx1, list("x1" = val, "x2" = val))
dfdx1_val_uneval
dfdx1_val <- doit(dfdx1_val_uneval)
dfdx1_val

dfdx2_val_uneval <- subs_lst(dfdx2, list("x1" = val, "x2" = val))
dfdx2_val_uneval
dfdx2_val <- doit(dfdx2_val_uneval)
dfdx2_val
```

\begin{align}
  f\left (`r inline_caracas_code(tex(val))`, `r inline_caracas_code(tex(val))` \right ) 
    &= `r inline_caracas_code(tex(f_val_uneval))` 
     = `r inline_caracas_code(tex(f_val))`  \\
  \frac{\partial f}{\partial x_1} \Bigg \vert_{x_1 = x_2 = `r inline_caracas_code(tex(val))`}
    &= `r inline_caracas_code(tex(dfdx1_val_uneval))` 
     = `r inline_caracas_code(tex(dfdx1_val))`  \\
  \frac{\partial f}{\partial x_2} \Bigg \vert_{x_1 = x_2 = `r inline_caracas_code(tex(val))`}
    &= `r inline_caracas_code(tex(dfdx2_val_uneval))` 
     = `r inline_caracas_code(tex(dfdx2_val))`
\end{align}

